<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui" template="../WEB-INF/template.xhtml"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">

	<ui:define name="head">
		<h:outputStylesheet name="css/flags/flags.css" library="demo" />
		<h:outputScript name="dataTable.js" library="javascript" />
		<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"></link>
	</ui:define>

	<ui:define name="title">#{resourceBundleServiceImpl.getMessage('orcamento_message')}</ui:define>

	<ui:define name="viewname">
		<li>#{resourceBundleServiceImpl.getMessage('compras_message')}</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li>#{resourceBundleServiceImpl.getMessage('orcamento_message')}</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li><p:link
				outcome="/faces/budgetEditing?budgetID=#{budgetEditingController.budgetID}">#{resourceBundleServiceImpl.getMessage('editar')} - #{budgetEditingController.budgetID}</p:link>
		</li>
	</ui:define>

	<ui:define name="content">
		<f:view locale="pt_BR">
			<f:metadata>
				<f:viewParam name="budgetID"
					value="#{budgetEditingController.budgetID}" id="idParam" />
			</f:metadata>

			<p:growl id="growl" showDetail="true" globalOnly="true"
				widgetVar="growl" skipDetailIfEqualsSummary="true" />
			<p:growl id="growlParam" showDetail="true" for="idParam" />

			<h:form>
				<p:remoteCommand autoRun="true"
					action="#{budgetEditingController.find}" process="@this"
					oncomplete="$('#divLoading').hide();$('#content').show();updateDtItems();"
					update="panelBudget,panelCustomer,panelTotals" />
			</h:form>

			<div class="card" id="divLoading">
				Loading...
				<div class="custom-skeleton p-p-4">
					<div class="p-d-flex p-mb-3">
						<p:skeleton shape="circle" size="4rem" class="p-mr-2" />
						<div>
							<p:skeleton width="10rem" class="p-mb-2" />
							<p:skeleton width="5rem" class="p-mb-2" />
							<p:skeleton height=".5rem" />
						</div>
					</div>
					<p:skeleton width="100%" height="150px" />
					<div class="p-d-flex p-jc-between p-mt-3">
						<p:skeleton width="4rem" height="2rem" />
						<p:skeleton width="4rem" height="2rem" />
					</div>
				</div>
			</div>
			<div id="content" style="display: none">
				<div class="card">
					<p:commandButton id="dynaButton" type="button" icon="pi pi-bars" />
					<h:form prependId="false">
						<p:menu overlay="true" trigger="dynaButton" my="left top"
							at="left bottom">
							<p:submenu label="Opções">
								<p:menuitem value="Confirmar"
									action="#{budgetEditingController.confirmBudgetEditing}"
									ajax="true" icon="pi pi-check"
									process="@this,oPNum,ocNum,mensagem"
									onstart="PF('sidebarForLoadingEditing').show()"
									oncomplete="PF('sidebarForLoadingEditing').hide()" />

								<p:menuitem value="Exportar" icon="pi pi-download"
									action="#{orderExportShowController.show(budgetEditingController.budget)}" />

								<p:menuitem value="Efetivar para pedido"
									action="#{budgetEditingController.saveToOrder}" ajax="true"
									icon="pi pi-star" process="@this,oPNum,ocNum,mensagem"
									onstart="PF('sidebarForSavingBudgetToOrder').show()"
									oncomplete="PF('sidebarForSavingBudgetToOrder').hide()" />
							</p:submenu>
						</p:menu>
						<p:dialog widgetVar="effectivedBudget" modal="true"
							responsive="true" header="Pedido salvo">
							<div class="p-grid p-flex-column">
								<div class="p-col">
									<div class="box">
										<p:staticMessage severity="info"
											summary="Efetivado para pedido com sucesso!"
											detail="Pedido de número #{budgetEditingController.savedOrder.code} foi gerado a partir deste orçamento"
											style="width: 100%" id="successPersisted" />
									</div>
								</div>
								<div class="p-col">
									<div class="box">
										<p:commandButton value="OK"
											oncomplete="PF('effectivedBudget').hide()" />
										<p:commandButton value="Visualizar outros pedidos"
											styleClass="p-mb-2" action="orders?faces-redirect=true" />
									</div>
								</div>
							</div>
						</p:dialog>
						<p:sidebar widgetVar="sidebarForLoadingEditing" position="top"
							baseZIndex="10000" modal="true" showCloseIcon="false">
							<h3 style="font-weight: normal">Alterando orçamento...</h3>
							<div class="p-d-flex p-ai-end">
								<p:skeleton shape="circle" size="2rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="3rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="4rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="5rem" />
							</div>
						</p:sidebar>
						<p:sidebar widgetVar="sidebarForSavingBudgetToOrder"
							position="top" baseZIndex="10000" modal="true"
							showCloseIcon="false">
							<h3 style="font-weight: normal">Efetivando pedido...</h3>
							<div class="p-d-flex p-ai-end">
								<p:skeleton shape="circle" size="2rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="3rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="4rem" class="p-mr-2" />
								<p:skeleton shape="circle" size="5rem" />
							</div>
						</p:sidebar>
					</h:form>
				</div>

				<div class="card">
					<h5>Orçamento</h5>
					<p:outputPanel deferred="true" deferredMode="visible"
						id="panelBudget">
						<div class="ui-fluid p-formgrid p-grid">
							<div class="p-field p-col-12 p-md-6">
								<label for="bCode">Código</label>
								<p:inputText id="bCode" type="text" readonly="true"
									value="#{budgetEditingController.budget.code}" />
							</div>
							<div class="p-field p-col-12 p-md-6">
								<label for="createdAt">Criado em</label>
								<p:inputText id="createdAt" type="text" readonly="true"
									value="#{budgetEditingController.budget.createdAt}">
									<f:convertDateTime locale="pt_BR" type="localDate"
										dateStyle="full" />
								</p:inputText>
							</div>
							<div class="p-field p-col-12 p-md-6">
								<label for="oPNum">N°Pedido representante</label>
								<p:inputText id="oPNum" type="text"
									value="#{budgetEditingController.budget.repNumOrder}" />
							</div>
							<div class="p-field p-col-12 p-md-6">
								<label for="ocNum">N°Pedido cliente</label>
								<p:inputText id="ocNum" type="text"
									value="#{budgetEditingController.budget.customerNumOrder}" />
							</div>
							<div class="p-field p-col-12 p-xl-4 p-lg-5 p-md-12">
								<p:outputLabel for="mensagem" value="Mensagem" />
								<p:inputTextarea id="mensagem" rows="4" maxlength="250"
									value="#{budgetEditingController.budget.message}" />
							</div>

						</div>
					</p:outputPanel>
				</div>
				<div class="card">
					<div class="p-grid">
						<div class="p-col-2">
							<h5>Cliente</h5>
						</div>
						<div class="p-col-2">
							<h:form>
								<p:commandButton icon="pi pi-search-plus"
									action="#{budgetEditingController.showCustomerData}"
									process="@this" update="@none" title="Visualizar cliente"
									styleClass="rounded-button ui-button-success "
									onstart="PF('sideBarForLoadingCustomer').show()"
									oncomplete="PF('sideBarForLoadingCustomer').hide()" />
							</h:form>

							<p:sidebar widgetVar="sideBarForLoadingCustomer" position="top"
								baseZIndex="10000" modal="true">
								<h3 style="font-weight: normal">Tratando cliente...</h3>
								<i class="pi pi-spin pi-spinner" style="font-size: 3rem"></i>
							</p:sidebar>

						</div>

					</div>
					<p:outputPanel deferred="true" deferredMode="visible"
						id="panelCustomer">
						<div class="ui-fluid p-formgrid p-grid">

							<div class="p-field p-col-12 p-md-6">
								<label for="cName">Código - Nome</label>
								<p:inputText id="cName" type="text" readonly="true"
									value="#{budgetEditingController.budget.customerOnOrder.code} - #{budgetEditingController.budget.customerOnOrder.name}" />
							</div>

							<div class="p-field p-col-12 p-md-6">
								<label for="cCnpj">CNPJ</label>
								<p:inputText id="cCnpj" type="text" readonly="true"
									value="#{budgetEditingController.budget.customerOnOrder.cnpj}" />
							</div>
							<div class="p-field p-col-12">
								<label for="cAddress">Endereço</label>
								<p:inputText id="cAddress" type="text" readonly="true"
									value="#{budgetEditingController.budget.customerOnOrder.address.street} - #{budgetEditingController.budget.customerOnOrder.address.district}, #{budgetEditingController.budget.customerOnOrder.address.city} - #{budgetEditingController.budget.customerOnOrder.address.state}" />
							</div>
						</div>
					</p:outputPanel>
				</div>
				<div class="p-grid crud-demo">
					<div class="p-col-12">
						<div class="card">
							<h5>Gerenciar itens</h5>

							<p:outputPanel deferred="true" deferredMode="visible"
								id="panelItems">
								<h:form prependId="false">
									<p:toolbar styleClass="p-mb-4">
										<p:toolbarGroup>
											<p:commandButton value="Novo" icon="pi pi-plus"
												styleClass="ui-button-raised ui-button-success"
												action="#{productSearchShowController.show(budgetEditingController.budget.customerOnOrder)}"
												style="margin-right: .5rem">
												<p:ajax event="dialogReturn"
													listener="#{budgetEditingController.handleProductResult}"
													onstart="PF('topSidebar').show()"
													oncomplete="PF('topSidebar').hide()" />
												<p:sidebar widgetVar="topSidebar" position="top"
													baseZIndex="10000">
													<h4>Adicionado produto ao orçamento e calculando
														totais...</h4>
												</p:sidebar>
											</p:commandButton>
											<p:commandButton
												value="#{resourceBundleServiceImpl.getMessage('abrir')}"
												icon="pi pi-folder-open"
												styleClass="ui-button-success p-mr-2"
												action="#{itemImportShowController.show(budgetEditingController.budget)}"
												process="@this">
												<p:ajax event="dialogReturn"
													listener="#{budgetEditingController.handleItemImportReturn}" />
											</p:commandButton>
											<p:commandButton id="delete-products-button"
												value="#{dtableBudgetEditingController.deleteButtonMessage}"
												icon="pi pi-trash"
												action="#{dtableBudgetEditingController.deleteItems(budgetEditingController.budget)}"
												styleClass="ui-button-danger"
												disabled="#{dtableBudgetEditingController.disableDeleteProductsBtn()}"
												process="@this" update="@this,dtItems,panelTotals">
												<p:confirm header="Confirmar"
													message="Deletar produtos selecionados?"
													icon="pi pi-exclamation-triangle" />
											</p:commandButton>
										</p:toolbarGroup>

									</p:toolbar>

									<p:remoteCommand name="updateDtItems" process="@none"
										update="dtItems" onstart="$('#divUpdatingDtItems').show();"
										oncomplete="$('#divUpdatingDtItems').hide();" />

									<div class="custom-skeleton p-p-4" id="divUpdatingDtItems">
										<div class="p-d-flex p-mb-3">
											<p:skeleton shape="circle" size="4rem" class="p-mr-2" />
											<div>
												<p:skeleton width="10rem" class="p-mb-2" />
												<p:skeleton width="5rem" class="p-mb-2" />
												<p:skeleton height=".5rem" />
											</div>
										</div>
										<p:skeleton width="100%" height="150px" />
										<div class="p-d-flex p-jc-between p-mt-3">
											<p:skeleton width="4rem" height="2rem" />
											<p:skeleton width="4rem" height="2rem" />
										</div>
									</div>

									<p:dataTable var="item"
										value="#{budgetEditingController.budget.items}" id="dtItems"
										widgetVar="dtItems" editable="true" scrollable="true"
										size="small" filterDelay="100"
										selection="#{dtableBudgetEditingController.items}"
										rowKey="#{item.product.commercialCode}" rowSelectMode="add"
										reflow="true">
										<f:facet name="header">

											<!--  	<p:menuButton
										value="#{resourceBundleServiceImpl.getMessage('descontos')}"
										disabled="#{empty budgetEditingController.budget.items}">
										<p:menuitem
											value="#{resourceBundleServiceImpl.getMessage('linha')}"
											action="#{orderDiscountShowController.show(budgetEditingController.budget,1)}"
											process="@this" icon="pi pi-tag">
											<p:ajax event="dialogReturn" update="dtItems,panelTotals" />
										</p:menuitem>
										<p:menuitem
											value="#{resourceBundleServiceImpl.getMessage('global')}"
											action="#{orderDiscountShowController.show(budgetEditingController.budget,0)}"
											icon="pi pi-tag">
											<p:ajax event="dialogReturn" update="dtItems,panelTotals" />
										</p:menuitem>
									</p:menuButton>-->
										</f:facet>
										<p:ajax event="rowToggle"
											listener="#{dtableBudgetEditingController.onRowToggle}" />

										<p:ajax event="rowEdit"
											listener="#{budgetEditingController.onRowItemEdit}"
											update="panelTotals" />

										<p:ajax event="rowSelect" update="delete-products-button" />
										<p:ajax event="rowUnselect" update="delete-products-button" />
										<p:ajax event="rowSelectCheckbox"
											update="delete-products-button" />
										<p:ajax event="rowUnselectCheckbox"
											update="delete-products-button" />
										<p:ajax event="toggleSelect" update="delete-products-button" />


										<p:column selectionMode="multiple"></p:column>
										<p:column exportable="false">
											<p:rowToggler />
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('codigo')}"
											filterBy="#{item.product.commercialCode}">
											<h:outputText value="#{item.product.commercialCode}" />
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('quantidade')}"
											sortBy="#{item.value.quantity}">
											<p:cellEditor>
												<f:facet name="output">
													<h:outputText value="#{item.value.quantity}" />
												</f:facet>
												<f:facet name="input">
													<p:spinner
														value="#{budgetEditingController.onRowItemQuantity}"
														style="width:100%" label="Quantidade" id="spnQ" />
													<p:tooltip
														value="Entre com um número múltiplo de #{item.value.multiple}"
														for="spnQ" />
												</f:facet>
											</p:cellEditor>

										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('valor_unitario')}"
											sortBy="#{item.product.value.unitValue}">
											<h:outputText value="#{item.product.value.unitValue}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('valor')}"
											sortBy="#{item.value.getTotalValueWithoutDiscount()}">
											<h:outputText
												value="#{item.value.getTotalValueWithoutDiscount()}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('total_st')}"
											sortBy="#{item.value.getTotalStValueWithoutDiscount()}">
											<h:outputText
												value="#{item.value.getTotalStValueWithoutDiscount()}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('valor_bruto')}"
											sortBy="#{item.value.getTotalGrossWithoutDiscount()}">
											<h:outputText
												value="#{item.value.getTotalGrossWithoutDiscount()}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('desc_linha')}"
											sortBy="#{item.value.lineDiscount}">
											<h:outputText value="#{item.value.lineDiscount}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('total_cm_desc')}"
											sortBy="#{item.value.totalValue}">
											<h:outputText value="#{item.value.totalValue}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column headerText="ST" sortBy="#{item.value.totalStValue}">
											<h:outputText value="#{item.value.totalStValue}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column
											headerText="#{resourceBundleServiceImpl.getMessage('bruto_cm_desc')}"
											sortBy="#{item.value.totalGrossValue}">
											<h:outputText value="#{item.value.totalGrossValue}">
												<f:convertNumber currencySymbol="R$" type="currency"
													locale="pt_BR" />
											</h:outputText>
										</p:column>
										<p:column style="width:4rem">
											<p:rowEditor editTitle="Edit Row" cancelTitle="Cancel Edit"
												saveTitle="Save Row" />

										</p:column>
										<p:column>
											<p:commandButton icon="pi pi-times"
												styleClass="rounded-button ui-button-danger ui-button-flat p-mr-2 p-mb-2"
												title="Remover"
												action="#{orderCommonBehaviorHelperImpl.removeItem(budgetEditingController.budget,item)}"
												oncomplete="editScrollBodyMaxHeight('dtItems','30vh')"
												update="dtItems,panelTotals" process="@this" />
										</p:column>

										<p:rowExpansion>
											<div id="rowData" class="p-grid p-ml-3  p-mt-2">
												<div id="div-img-wrraper" class="p-col-fixed"
													style="width: 11.7rem">
													<div id="div-img-loader-#{item.product.commercialCode}" style="display: none">
														<i class="pi pi-spin pi-spinner" style="font-size: 3rem;" />
													</div>
													<div id="div-img-#{item.product.commercialCode}">
														<h:form>
															<p:graphicImage value="#{item.product.imageStreams}"
																stream="false"
																styleClass="w3-round-xlarge product-image"
																style="height: 8.2rem; width: 10rem" id="img"
																alt="Imagem não encontrada"
																rendered="#{item.product.image.currentState eq 'FOUND' || item.product.image.currentState eq 'NOT_FOUND'}" />

															<p:commandButton value="Imagem" icon="pi pi-image"
																action="#{productImageLoaderController.loadImage(item.product)}"
																rendered="#{item.product.image.currentState eq 'NOT_LOADED' || item.product.image.currentState eq 'TIMEOUT_EXCPTION'}"
																update="@form" process="@this"
																onstart="$('#div-img-loader-#{item.product.commercialCode}').show();$('#div-img-#{item.product.commercialCode}').hide();"
																oncomplete="$('#div-img-loader-#{item.product.commercialCode}').hide();$('#div-img-#{item.product.commercialCode}').show();" />

														</h:form>
													</div>

												</div>
												<div class="p-col-2">
													<div class="p-text-bold p-mb-2">#{item.product.commercialCode}</div>
													<div class="p-text-normal">#{item.product.description}</div>
												</div>
												<div class="p-col" id="product-tech-loader-#{item.product.commercialCode}"
													style="display: none">
													Buscando detalhes técnicos... <i
														class="pi pi-spin pi-spinner" style="font-size: 3rem;" />
												</div>
												<div class="p-col-6" id="product-tech-#{item.product.commercialCode}">
													<h:form>
														<p:panelGrid columns="4"
															columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4"
															layout="grid" styleClass="ui-panelgrid-blank ui-fluid"
															style="border:0px none; background-color:transparent;"
															id="pnTechData"
															rendered="#{item.product.productTechDetail != null}">

															<p:outputLabel for="@next" value="Aplicação:" styleClass="p-text-bold"/>
															<p:outputLabel
																value="#{item.product.productTechDetail.application}"
																styleClass="label-r" />

															<p:outputLabel for="@next" value="Substituições:" styleClass="p-text-bold"/>
															<p:outputLabel
																value="#{item.product.productTechDetail.productsReplaces}"
																styleClass="label-r" />

															<p:outputLabel for="@next" value="Peso bruto:" styleClass="p-text-bold"/>
															<p:outputLabel
																value="#{item.product.productTechDetail.grossWeight}"
																styleClass="label-r" />

															<p:outputLabel for="@next" value="Dimensões da caixa:" styleClass="p-text-bold"/>
															<p:outputLabel
																value="#{item.product.productTechDetail.packageDimension}"
																styleClass="label-r" />


															<p:linkButton href="#{item.product.link}" value="Site"
																icon="pi pi-external-link" target="_blank"/>

														</p:panelGrid>
														<p:commandButton value="Dados técnicos"
															rendered="#{item.product.productTechDetail eq null}"
															icon="pi pi-th-large"
															action="#{productTechDetailLoaderController.load(item.product)}"
															onstart="$('#product-tech-loader-#{item.product.commercialCode}').show();$('#product-tech-#{item.product.commercialCode}').hide();"
															oncomplete="$('#product-tech-loader-#{item.product.commercialCode}').hide();$('#product-tech-#{item.product.commercialCode}').show();"
															update="@form" process="@this" />
													</h:form>

												</div>
											</div>
										</p:rowExpansion>
									</p:dataTable>
								</h:form>
							</p:outputPanel>
						</div>
					</div>
				</div>

				<div class="card">
					<p:outputPanel id="panelTotals" deferred="true"
						deferredMode="visible">
						<h:form id="totals">
							<div class="ui-fluid p-formgrid p-grid">
								<div class="p-field p-col-12 p-md-3">
									<p:outputLabel for="liquidV"
										value="#{resourceBundleServiceImpl.getMessage('total_sem_st')}" />
									<p:inputNumber id="liquidV"
										value="#{budgetEditingController.budget.liquidValue}"
										symbol="R$ " symbolPosition="p" readonly="true"
										decimalSeparator="," thousandSeparator="." />
								</div>
								<div class="p-field p-col-12 p-md-3">
									<p:outputLabel for="stT"
										value="#{resourceBundleServiceImpl.getMessage('valor_st')}" />
									<p:inputNumber id="stT"
										value="#{budgetEditingController.budget.stValue}" symbol="R$ "
										symbolPosition="p" readonly="true" decimalSeparator=","
										thousandSeparator="." />
								</div>
								<div class="p-field p-col-12 p-md-3">
									<p:outputLabel for="grossV"
										value="#{resourceBundleServiceImpl.getMessage('total_com_st')}" />
									<p:inputNumber id="grossV"
										value="#{budgetEditingController.budget.grossValue}"
										symbol="R$ " symbolPosition="p" readonly="true"
										decimalSeparator="," thousandSeparator="." />
								</div>
							</div>
							<p:autoUpdate on="eventAddItem" />
						</h:form>
					</p:outputPanel>
				</div>
				<p:confirmDialog global="true" showEffect="fade" hideEffect="fade"
					responsive="true" width="350">
					<p:commandButton value="Sim" type="button"
						styleClass="ui-confirmdialog-yes" />
					<p:commandButton value="Não" type="button"
						styleClass="ui-confirmdialog-no ui-button-flat" />

				</p:confirmDialog>
			</div>
		</f:view>
	</ui:define>

</ui:composition>