<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="../../WEB-INF/template.xhtml"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:jsf="http://xmlns.jcp.org/jsf" xmlns:o="http://omnifaces.org/ui">

	<ui:define name="head">
		<h:outputStylesheet name="css/flags/flags.css" library="demo" />
	</ui:define>

	<ui:define name="title">Monitoramento de conexões</ui:define>

	<ui:define name="viewname">
		<li>Conexões</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li>Monitoramento</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li><p:link outcome="/faces/connections/monitor">Monitor de conexões</p:link>
		</li>
	</ui:define>

	<ui:define name="content">
		<audio id="notification-audio">
			<source src="../../resources/sound/notification_sound.mp3"
				type="audio/mpeg" />
		</audio>
		<div class="grid table-demo">
			<div class="col-12">
				<div jsf:id="divListContent" class="card">
					<h4>Monitor de conexões ativas</h4>
					<h:form>
						<p:commandButton value="Throw exception"
							action="#{connectionsSessionsMonitorController.throwException}"
							process="@this" />
						<p:remoteCommand name="updateTable" process="@none" update="table" />
						<p:dataTable id="table"
							value="#{connectionsSessionsMonitorController.activeConnections}"
							var="conn" reflow="true">
							<f:facet name="header">

							</f:facet>
							<p:column field="id" filterable="false" headerText="ID" />
							<p:column headerText="Criada" sortable="false">
								<h:outputText value="#{conn.startedAt}">
									<f:convertDateTime pattern="MM/dd/yyyy 'às' HH:mm:ss"
										type="localDateTime" />
								</h:outputText>
							</p:column>/
						<p:column field="user" filterable="false" />
							<p:column field="userAgent" filterable="true" sortable="false" />
							<p:column field="locale.displayCountry" sortable="false"
								headerText="Origem" />
							<p:column field="ip" sortable="false" filterable="false"
								headerText="IP" />
							<p:column style="width:6rem">
								<p:commandButton value="Chat" icon="pi pi-comments"
									title="Iniciar chat" process="@this"
									action="#{connectionsSessionsMonitorController.startChat(conn)}"
									onstart="PF('startChatLoading').show()"
									oncomplete="startChat(args,'#{conn.user}')" />
							</p:column>
						</p:dataTable>
						<p:spotlight target="@form" widgetVar="spot" />
					</h:form>
				</div>
			</div>
		</div>
		<p:dialog header="Iniciando bate-papo..." modal="true"
			closable="false" widgetVar="startChatLoading">
			<p:progressBar id="progressBarIndeterminate" style="height:6px"
				mode="indeterminate" />
		</p:dialog>
		<o:socket channel="connectionMonitorChannel"
			onmessage="onConnectionListener" />
		<script>
			let audio = document.getElementById("notification-audio")
			function onConnectionListener(message, channel, event) {
				updateTable();
				playNotification();
				PF('spot').show();
				setTimeout(() => {
					PF('spot').hide();
				}, 600);
			}

			function playNotification() {
				audio.play().then(()=>{
					
				}).catch(()=>{
					console.log("som não disponível")
				});
			}
			
			function startChat(args,user){
				PF('startChatLoading').hide();
				PF('dlgChat').show();
				sessionStorage.setItem("conversation_id",args.conversation_id);
				document.getElementById("p-chat").innerHTML = "Conectado com "
					+ user;
			}
		</script>
	</ui:define>

</ui:composition>
