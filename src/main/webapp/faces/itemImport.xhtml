<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:head>
	<f:facet name="first">
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<link rel="icon"
			href="#{request.contextPath}/resources/rain-layout/images/favicon.ico"
			type="image/x-icon"></link>
	</f:facet>
	<title>Importar itens</title>
	<style>
/* reset on the showcase style*/
body .ui-panelgrid .ui-panelgrid-cell {
	background-color: transparent;
}

/* example use of styles for your form */
.my-heading-row {
	background-color: green;
	font-weight: bold;
}
</style>
</h:head>

<h:body styleClass="#{userStylePreferences.inputStyleClass}">
	<f:metadata>
		<f:viewParam name="customerCode"
			value="#{itemImportController.customerCode}" />
		<f:viewParam name="customerStore"
			value="#{itemImportController.customerStore}" />
		<f:viewParam name="isOnDialog"
			value="#{itemImportController.onDialog}" />
	</f:metadata>
	<p:growl globalOnly="true" id="growl" showDetail="true" />
	<div class="card">
		<h:form>
			<h5>Arquivo</h5>
			<p:fileUpload mode="advanced" dragDropSupport="true"
				allowTypes="/(\.|\/)(xlsx)$/" cancelLabel="Cancelar"
				label="Escolher" listener="#{itemImportController.handleFileUpload}"
				process="@this" invalidFileMessage="Arquivo inválido" auto="true" />
		</h:form>
	</div>
	<div class="card">
		<p:panelGrid columns="4"
			columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4"
			layout="grid" styleClass="ui-panelgrid-blank ui-fluid"
			style="border:0px none; background-color:transparent;"
			id="pnFileLayout">
			<p:row styleClass="my-heading-row">
            Layout
        </p:row>
			<p:outputLabel for="@next"
				value="Posição de ínicio para lista de itens" />
			<p:spinner
				value="#{itemImportController.itemFileLayout.initPosition}" />

			<p:outputLabel for="@next" value="Última posição para lista de itens" />
			<p:spinner
				value="#{itemImportController.itemFileLayout.lastPosition}" />

			<p:row style="font-weight: bold">
           Posições das colunas/células relevantes ao produto
        </p:row>

			<p:outputLabel for="@next" value="Código" />
			<p:spinner
				value="#{itemImportController.itemFileLayout.offSetCellForProductCode}" />

			<p:outputLabel for="@next" value="Quantidade" />
			<p:spinner
				value="#{itemImportController.itemFileLayout.offSetCellForProductQuantity}" />

			<p:row>
				<p:column styleClass="ui-grid-col-12">
					<p:commandButton value="Examinar" styleClass="p-mr-2"
						style="width: auto" process="pnFileLayout"
						action="#{itemImportController.readFile}"
						onstart="PF('dlgImporting').show()"
						oncomplete="PF('dlgImporting').hide()" />

				</p:column>
			</p:row>
		</p:panelGrid>
	</div>

	<p:dialog header="Valores obtidos a partir da examinação da planilha"
		footer="Verifique os valores" modal="true" widgetVar="dlgResult"
		responsive="true" style="max-width: 30vw;max-height:80vh"
		onShow="editScrollBodyMaxHeight('dtItemsResult','35vh');PF('dtItemsResult').clearFilters();">
		<p:outputPanel deferredMode="visible" deferred="true" id="readResult">
			<h:form prependId="false">
				<p:dataTable id="dtItemsResult" widgetVar="dtItemsResult"
					value="#{itemImportController.itemXlsxProjection}" var="item"
					editable="true" editMode="cell" reflow="true" scrollable="true"
					filterDelay="75" paginator="true" paginatorPosition="bottom"
					paginatorAlwaysVisible="false" rows="10">
					<p:ajax event="cellEdit"
						listener="#{itemImportController.onCellEdit}" update="growl" />
					<p:column headerText="Produto" filterBy="#{item.code}"
						id="columnCode">
						<p:cellEditor>
							<f:facet name="input">
								<p:inputText value="#{item.code}" />
							</f:facet>
							<f:facet name="output">
								<h:outputText value="#{item.code}" />
							</f:facet>
						</p:cellEditor>

					</p:column>
					<p:column headerText="Quantidade" id="columnQuantity">
						<p:cellEditor>
							<f:facet name="input">
								<p:spinner value="#{item.quantity}" min="1" />
							</f:facet>
							<f:facet name="output">
								<h:outputText value="#{item.quantity}" />
							</f:facet>
						</p:cellEditor>
					</p:column>
					<p:column>
						<p:commandButton icon="pi pi-times"
							styleClass="rounded-button ui-button-danger"
							action="#{itemImportController.removeItemXlsxProjection(item)}"
							process="@this" update="dtItemsResult"
							oncomplete="editScrollBodyMaxHeight('dtItemsResult','35vh');PF('dtItemsResult').clearFilters();" />
					</p:column>
				</p:dataTable>
			</h:form>
		</p:outputPanel>
		<f:facet name="footer">
			<p:commandButton value="Cancelar" icon="pi pi-arrow-left"
				iconPos="left" styleClass="ui-button-danger"
				onclick="PF('dlgResult').hide()"
				action="#{itemImportController.cancelExa}" process="@this" />
			<p:button value="Próximo" icon="pi pi-arrow-right" iconPos="right"
				onclick="discoverItems()" />
		</f:facet>
	</p:dialog>

	<p:dialog header="Itens não encontrados" modal="true"
		widgetVar="dlgItemsNotFound" responsive="true"
		style="max-width: 20vw;max-height:80vh"
		onShow="editScrollBodyMaxHeight('dtItemsResult','35vh');PF('dtItemsNotFound').clearFilters();">
		<p:outputPanel deferredMode="visible" deferred="true">
			<h:form prependId="false">
				<p:dataTable id="dtItemsNotFound" widgetVar="dtItemsNotFound"
					value="#{itemImportController.itemsNotFound}" var="item"
					reflow="true" scrollable="true" filterDelay="75">
					<p:column headerText="Item" id="columnCode">
						<h:outputText value="#{item.itemIdentity}" />
					</p:column>
				</p:dataTable>
			</h:form>
		</p:outputPanel>
		<f:facet name="footer">
			<p:commandButton value="Cancelar" icon="pi pi-arrow-left"
				iconPos="left" styleClass="ui-button-danger"
				onclick="PF('dlgItemsNotFound').hide()"
				action="#{itemImportController.cancelExa}" process="@this" />
			<p:button value="Prosseguir e ignorar estes itens"
				icon="pi pi-arrow-right" iconPos="right" onclick="discoverItems()" />
		</f:facet>
	</p:dialog>

	<h:form>
		<p:remoteCommand name="discoverItems"
			action="#{itemImportController.discoverItems}" process="@this"
			onstart="PF('dlgDiscoveringItems').show()"
			oncomplete="PF('dlgDiscoveringItems').hide()" />
	</h:form>

	<p:dialog header="Lendo arquivo..." modal="true" closable="false"
		widgetVar="dlgImporting">
		<i class="pi pi-spin pi-spinner" style="font-size: 4rem"></i>
	</p:dialog>

	<p:dialog header="Obtendo itens..." modal="true" closable="false"
		widgetVar="dlgDiscoveringItems">
		<i class="pi pi-spin pi-spinner" style="font-size: 4rem"></i>
	</p:dialog>
	<h:outputStylesheet name="css/#{userStylePreferences.layout}.css"
		library="rain-layout" />
	<h:outputScript name="dataTable.js" library="javascript" />
</h:body>
</html>

