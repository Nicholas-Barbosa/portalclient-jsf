<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui" template="../../WEB-INF/template.xhtml"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:ic="http://java.sun.com/jsf/composite/components/item"
	xmlns:cstomer="http://java.sun.com/jsf/composite/components/customer">

	<ui:define name="head">
		<h:outputStylesheet name="css/flags/flags.css" library="demo" />
		<h:outputScript name="CssModifier.js" library="javascript" />
		<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"></link>
		<h:outputStylesheet name="item-row-expansion.css" library="css" />
		<h:outputScript name="dataTable.js" library="javascript" />

	</ui:define>

	<ui:define name="title">
		FarAway | #{resourceBundleServiceImpl.getMessage('orcamento_message')}
	</ui:define>

	<ui:define name="viewname">
		<li>#{resourceBundleServiceImpl.getMessage('compras_message')}</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li>#{resourceBundleServiceImpl.getMessage('orcamento_message')}
		</li>
		<li><i class="pi pi-chevron-right"></i></li>
		<li><p:link outcome="/faces/budget/new">
					#{resourceBundleServiceImpl.getMessage('novo_orcamento')}
			</p:link></li>
	</ui:define>

	<ui:define name="content">
		<f:view locale="pt_BR">

			<p:growl id="growl" showDetail="true" globalOnly="true"
				widgetVar="growl" />
			<div class="card">

				<h:form id="budgetToolsForm">
					<p:toolbar id="tb">
						<p:toolbarGroup>

							<p:commandButton
								value="#{resourceBundleServiceImpl.getMessage('novo')}"
								icon="pi pi-file" styleClass="p-mr-2"
								action="#{newBudgetOrderController.newBudget}"
								update="customerForm itemsComponent:panelItems budgetTotals">
								<p:confirm type="popup"
									header="#{resourceBundleServiceImpl.getMessage('confirmacao')}"
									message="#{resourceBundleServiceImpl.getMessage('restaurar_budget_form')}"
									icon="pi pi-info-circle" />
							</p:commandButton>

							<p:commandButton action="#{newBudgetOrderController.validBudget}"
								value="#{resourceBundleServiceImpl.getMessage('salvar_orcamento')}"
								icon="pi pi-check" styleClass="ui-button-success " />
							<i class="pi pi-bars p-px-2" />
							<p:commandButton title="Print" icon="pi pi-print"
								styleClass="ui-button-success p-mr-2"
								action="#{budgetExporterShowController.show(newBudgetOrderController.budget)}"
								process="@this" />


							<p:commandButton
								value="#{resourceBundleServiceImpl.getMessage('cliente')}"
								icon="pi pi-eye"
								action="#{customerDetailShowController.show(newBudgetOrderController.budget.customerOnOrder)}" />

						</p:toolbarGroup>
					</p:toolbar>
					<p:sticky target="tb" />
				</h:form>
			</div>

			<div class="card">
				<h:form id="customerForm">
					<div class="ui-fluid p-formgrid p-grid">
						<div class="p-field p-col-12 p-xl-4 p-lg-5 p-md-12">
							<p:outputLabel
								value="#{resourceBundleServiceImpl.getMessage('cliente')}" />
							<div class="ui-inputgroup">
								<p:inputText
									value="#{newBudgetOrderController.budget.customerOnOrder.name}-#{newBudgetOrderController.budget.customerOnOrder.store}"
									readonly="true" />
								<p:button icon="pi pi-search" styleClass="ui-button-warning"
									onclick="PF('dlgSearchCustomer').show()"
									disabled="#{not empty newBudgetOrderController.budget.items}"
									id="btnShowSearchCustomer">
									<p:autoUpdate on="eventAddItem" />
								</p:button>
							</div>
						</div>

						<div class="p-field p-col-12 p-xl-3 p-lg-2  p-md-12">
							<p:outputLabel value="CNPJ" for="cnpj" />
							<p:inputMask
								value="#{newBudgetOrderController.budget.customerOnOrder.cnpj}"
								readonly="true" id="cnpj" mask="99.999.999/9999-99" />
						</div>
						<div class="p-field p-col-12 p-xl-4 p-lg-4 p-md-12">
							<p:outputLabel for="endereco"
								value="#{resourceBundleServiceImpl.getMessage('endereco')}" />
							<p:inputText id="endereco"
								value="#{newBudgetOrderController.budget.customerOnOrder.street}, #{newBudgetOrderController.budget.customerOnOrder.city} - #{newBudgetOrderController.budget.customerOnOrder.state}"
								readonly="true" />
						</div>
						<div class="p-field p-col-12 p-xl-3 p-lg-2  p-md-12">
							<p:outputLabel
								value="#{resourceBundleServiceImpl.getMessage('condicao_pagamento')}"
								for="pTerms" />
							<p:inputText
								value="#{newBudgetOrderController.budget.customerOnOrder.paymentTerms}"
								readonly="true" id="pTerms" />
						</div>

						<ui:fragment
							rendered="#{newBudgetOrderController.budget.customerOnOrder.type eq 'PROSPECT'}">

							<div class="p-field p-col-12 p-xl-3 p-lg-2  p-md-12">
								<p:outputLabel value="Vendedor" for="sellerType" />
								<p:inputText
									value="#{newBudgetOrderController.budget.customerOnOrder.sellerType}"
									readonly="true" id="sellerType" />
							</div>

						</ui:fragment>
						<div class="p-field p-col-12 p-xl-4 p-lg-5 p-md-12">
							<p:outputLabel for="mensagem" value="Mensagem" />
							<p:inputTextarea id="mensagem" rows="4" maxlength="250"
								value="#{newBudgetOrderController.budget.message}"
								onchange="saveMessage();" />
						</div>
						<p:remoteCommand name="saveMessage" process="@this,@form:mensagem"
							action="#{orderMessageMessageController.displayMessage}" />


					</div>
				</h:form>
			</div>

			<ic:itemDtableComponent
				handleProductSearchResultAction="#{newBudgetOrderController.handleProductResult}"
				handleItemImportAction="#{newBudgetOrderController.handleItemImportReturn}"
				itemComponentController="#{newBudgetOrderController.dtItemsController}"
				totalComponent="budgetTotals" renderDiscountButton="true"
				id="itemsComponent" />


			<div class="p-col-12 p-shadow-24" id="totals">
				<div class="card ">
					<h:form id="budgetTotals">
						<div class="ui-fluid p-formgrid p-grid">
							<div class="p-field p-col-12 p-md-3">
								<p:outputLabel for="liquidV"
									value="#{resourceBundleServiceImpl.getMessage('total_sem_st')}" />
								<p:inputNumber id="liquidV"
									value="#{newBudgetOrderController.budget.liquidValue}"
									symbol="R$ " symbolPosition="p" readonly="true"
									decimalSeparator="," thousandSeparator="." />
							</div>
							<div class="p-field p-col-12 p-md-3">
								<p:outputLabel for="stT"
									value="#{resourceBundleServiceImpl.getMessage('valor_st')}" />
								<p:inputNumber id="stT"
									value="#{newBudgetOrderController.budget.stValue}" symbol="R$ "
									symbolPosition="p" readonly="true" decimalSeparator=","
									thousandSeparator="." />
							</div>
							<div class="p-field p-col-12 p-md-3">
								<p:outputLabel for="grossV"
									value="#{resourceBundleServiceImpl.getMessage('total_com_st')}" />
								<p:inputNumber id="grossV"
									value="#{newBudgetOrderController.budget.grossValue}"
									symbol="R$ " symbolPosition="p" readonly="true"
									decimalSeparator="," thousandSeparator="." />
							</div>
						</div>
						<p:autoUpdate on="eventAddItem" />
					</h:form>
				</div>

			</div>

			<p:dialog widgetVar="dlgSearchCustomer" modal="true"
				header="#{holdMessageView.label('busca_de_cliente')}"
				positionType="absolute" responsive="true" blockScroll="true">
				<div style="max-height: 65vh; overflow: auto">
					<p:tabView>
						<p:tab
							title="#{resourceBundleServiceImpl.getMessage('palavra_chave')}">
							<h5>
								<h:outputText
									value="#{resourceBundleServiceImpl.getMessage('busca_por_nome_cliente')}" />
							</h5>
							<h:form>

								<div class="p-formgroup-inline">
									<div class="p-field">
										<div class="ui-inputgroup">
											<p:inputText type="text" placeholder="keyword"
												value="#{newBudgetOrderController.cNameToSearch}"
												required="true" id="cName" />

											<p:commandButton icon="pi pi-search"
												action="#{customerSearchShowController.show(newBudgetOrderController.cNameToSearch)}">
												<p:ajax event="dialogReturn"
													listener="#{newBudgetOrderController.handleCustomerResult}"  />
											</p:commandButton>
										</div>

										<p:message for="cName" />
									</div>

								</div>
							</h:form>
						</p:tab>

						<p:tab title="PROSPECT">
							<cstomer:prospectForm
								order="#{newBudgetOrderController.budget}"
								update=":customerForm,budgetToolsForm"
								oncompleteJsCode="PF('blockItems').hide();PF('dlgSearchCustomer').hide();" />
						</p:tab>
					</p:tabView>
				</div>
			</p:dialog>

			<p:confirmPopup global="true">
				<p:commandButton value="#{holdMessageView.label('nao')}"
					type="button" styleClass="ui-confirm-popup-no ui-button-flat" />
				<p:commandButton value="#{holdMessageView.label('sim')}"
					type="button" styleClass="ui-confirm-popup-yes" />
			</p:confirmPopup>
			
			<p:remoteCommand name="cleanBudgetObj"
				action="#{newBudgetOrderController.newBudget}" process="@this"
				update="customerForm, :itemsComponent, budgetTotals" />

			<p:dialog widgetVar="dlgBudgetPersistForm" modal="true"
				header="#{resourceBundleServiceImpl.getMessage('efetivar_orcamento')}"
				responsive="true">
				<h:form>
					<div class="ui-fluid p-formgrid p-grid">
						<div class="p-field p-col">
							<label for="pR">#{resourceBundleServiceImpl.getMessage('pedido_representante')}</label>
							<p:inputText id="pR" type="text"
								value="#{newBudgetOrderController.customerRepresentativeOrderForm.representativeOrder}" />
						</div>
						<div class="p-field p-col">
							<label for="pC">#{resourceBundleServiceImpl.getMessage('pedido_cliente')}</label>
							<p:inputText id="pC" type="text"
								value="#{newBudgetOrderController.customerRepresentativeOrderForm.customerOrder}" />
						</div>
					</div>
					<p:commandButton icon="pi pi-check" styleClass="ui-button-success"
						process="@this,@form" action="#{newBudgetOrderController.save}"
						onstart="PF('persistingBudget').show();PF('dlgBudgetPersistForm').hide();"
						oncomplete="onCompletePersistBudget()" />
				</h:form>
			</p:dialog>

			<p:dialog header="Status" modal="true" closable="false"
				widgetVar="persistingBudget" responsive="true">
				<div id="statLoading">
					<h5 class="p-mt-3">#{resourceBundleServiceImpl.getMessage('salvando_orcamento')}</h5>
					<div class="p-d-flex p-ai-end">
						<p:skeleton size="2rem" class="p-mr-2" />
						<p:skeleton size="3rem" class="p-mr-2" />
						<p:skeleton size="4rem" class="p-mr-2" />
						<p:skeleton size="5rem" />
					</div>
				</div>

				<div id="statConluded" class="p-grid p-flex-column"
					style="display: none;">
					<div class="p-col">
						<div class="box">
							<p:staticMessage severity="info" summary="Salvo com sucesso!"
								detail="Orçamento de número #{newBudgetOrderController.budget.code}"
								style="width: 100%" id="successPersisted" />
						</div>
					</div>
					<div class="p-col">
						<div class="box">
							<p:commandButton value="OK"
								action="#{newBudgetOrderController.newBudget}" process="@this"
								update="customerForm, itemsComponent, budgetTotals"
								styleClass="p-mr-2 p-mb-2"
								oncomplete="PF('persistingBudget').hide()" />
							<p:linkButton value="Visualizar outros pedidos" icon="pi pi-star"
								outcome="/faces/budget/budgets" styleClass="p-mb-2" />
						</div>
					</div>
				</div>
			</p:dialog>
			<p:sidebar widgetVar="topSidebar" position="top" baseZIndex="10000">
				<h4>Adicionado produto ao orçamento e calculando totais...</h4>
			</p:sidebar>
			<style type="text/css">
.cheap {
	background-color: #ff9999 !important;
	background-image: none !important;
	color: #000000 !important;
}

/* reset on the showcase style*/
body .ui-panelgrid .ui-panelgrid-cell {
	background-color: transparent;
}

/* example use of styles for your form */
.my-heading-row {
	background-color: var(- -surface-c);
	font-weight: bold;
}
</style>

			<script type="text/javascript">
				//<![CDATA[
				var processFinished = false;

				function turnDtScrollBodyResponsive(clientId, maxHeight) {
					PF(clientId).scrollBody[0].style.setProperty('max-height',
							maxHeight);
				}

				function getResponseHeader(xhr) {
					return xhr.getResponseHeader("Backbone-Status") != "Error";
				}
				function onCompletePersistBudget() {
					$("#statLoading").hide();
					$("#statConluded").show();
				}
				//	]]>
			</script>
		</f:view>
	</ui:define>

</ui:composition>